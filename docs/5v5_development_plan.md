# 5v5 团队赛功能开发方案

为现有项目增加5v5团队赛功能是一个重要的迭代。根据`GEMINI.md`中的描述“后期版本可考虑增加，项目设计需注意兼容性”，我们需要在现有1v1个人赛的基础上进行扩展。

这是一个系统性的工程，涉及到数据库、后端API、前端UI和自动化逻辑的全面升级。以下是详细的开发步骤和需要修改的关键点：

### A. 数据库层面 (Data Layer)

这是所有改动的基础。我们需要引入“团队”和“团队成员”的概念。

1.  **新增 `Teams` 表:** 用于存储团队信息。
    *   `id`: 主键
    *   `name`: 团队名称 (唯一)
    *   `captain_id`: 队长ID (外键关联 `Users` 表，即创建者)
    *   `logo_url`: 团队Logo图片地址 (可选)
    *   `created_at`: 创建时间

2.  **新增 `TeamMembers` 表:** 用于管理团队成员关系（多对多）。
    *   `id`: 主键
    *   `team_id`: 团队ID (外键关联 `Teams` 表)
    *   `player_id`: 玩家ID (外键关联 `Users` 表)
    *   `joined_at`: 加入时间

3.  **修改 `Tournaments` (比赛表):**
    *   新增 `type` 字段: 用于区分比赛类型，例如 `'1v1'` 或 `'5v5'`。这是所有后续逻辑判断的基础。

4.  **修改 `Registrations` (报名表):**
    *   需要支持团队报名。一个直接的方案是新增 `team_id` 字段 (外键关联 `Teams` 表)，该字段在1v1比赛中为 `NULL`，在5v5比赛中记录团队ID。

5.  **修改 `Matches` (对阵表):**
    *   需要支持团队对阵。同样，可以新增 `team1_id` 和 `team2_id` 字段。在5v5比赛中，`player1_id` 和 `player2_id` 可以为 `NULL`。
    *   `winner_id` 字段需要能同时指向 `Users` 表的ID（1v1胜者）或 `Teams` 表的ID（5v5胜者），这需要后端逻辑来处理。

### B. 后端 API 层面 (Backend Layer)

所有与团队相关的功能都需要新的API端点，并且现有API需要兼容新模式。

1.  **新增团队管理API (`/api/teams/...`):**
    *   `POST /api/teams`: 创建团队 (只有登录玩家可以创建，创建者自动成为队长)。
    *   `GET /api/teams/[id]`: 获取团队详情（包括成员列表）。
    *   `PUT /api/teams/[id]`: 更新团队信息（如名称、Logo，仅限队长）。
    *   `POST /api/teams/[id]/members`: 邀请或添加成员到团队。
    *   `DELETE /api/teams/[id]/members/[playerId]`: 从团队移除成员（仅限队长）。

2.  **修改比赛管理API (`/api/tournaments/...`):**
    *   **创建比赛 (`POST /api/tournaments`):** 请求体中需加入 `type: '5v5'` 参数。`min_players` 和 `max_players` 的含义需要明确为“最少/最多队伍数”。
    *   **获取比赛 (`GET /api/tournaments`):** 返回数据中应包含比赛 `type`。

3.  **修改报名逻辑API (`/api/registrations/...`):**
    *   **报名 (`POST /api/registrations`):**
        *   API需要先检查比赛的 `type`。
        *   如果 `type` 是 `'5v5'`，则只允许团队队长为自己的队伍报名，请求中需要包含 `team_id`。
        *   后端需要验证报名团队的人数是否符合比赛要求（例如，必须满5人）。
    *   **退出报名 (`.../withdraw`):** 同样需要区分是个人退出还是团队退出。

4.  **修改比赛流程控制API:**
    *   **生成对阵 (`/api/tournaments/[id]/start`):** `generateMatchesAndStartTournament` 工具函数需要重构，使其能根据比赛 `type` 来处理团队ID列表或玩家ID列表，生成团队间的对阵。
    *   **设置获胜者 (`/api/matches/[id]/winner`):** API需要能接受 `winner_team_id` 作为参数，并将胜利记录给整个团队。

### C. 前端 UI/UX 层面 (Frontend Layer)

用户界面需要进行大幅调整以支持团队功能。

1.  **新增团队相关页面:**
    *   **“我的团队”页面:** 允许玩家创建、查看和管理自己所属的团队。
    *   **团队公开主页:** 展示团队信息、成员列表和历史战绩。

2.  **修改现有页面:**
    *   **创建比赛页面:** 增加“比赛模式”选项（1v1个人赛 / 5v5团队赛）。根据所选模式，调整“参赛人数”等选项的标签和含义（例如，变为“参赛队伍数”）。
    *   **比赛详情页:**
        *   如果比赛是5v5模式，已报名列表应显示团队名称和Logo，而不是单个玩家头像。
        *   报名按钮的逻辑需要修改，只有团队队长才能看到“为队伍报名”的按钮。
    *   **对阵图页面:** 对阵图需要能清晰地展示对阵双方的团队名称和Logo。

### D. 自动化逻辑层面 (Automation Layer)

核心的自动化流程需要扩展。

1.  **匹配逻辑:** 现有的匹配算法（可能是随机抽签分组）需要从操作玩家列表改为操作团队列表。
2.  **晋级逻辑:** 主办方选择胜者后，系统需要将获胜的团队晋级到下一轮。
3.  **最终排名生成:** 排名规则需要适配团队，根据团队被淘汰的轮次进行排名。

### 总结与建议

开发5v5功能是一个复杂但可行的任务。我建议采用以下分步迭代的策略：

1.  **第一阶段：基础建设 (后端)**
    *   完成上述所有数据库表的修改和新增。
    *   开发完整的团队管理API (`/api/teams/...`)。
    *   让开发者可以手动在数据库中创建5v5类型的比赛进行测试。

2.  **第二阶段：核心流程 (后端 + 前端)**
    *   修改比赛创建、报名和开始的API及前端页面，使其支持5v5模式。
    *   实现团队报名和退出报名的核心逻辑。

3.  **第三阶段：比赛进行与展示 (后端 + 前端)**
    *   重构对阵生成和获胜者判定的逻辑。
    *   更新比赛详情页和对阵图，使其能正确显示团队信息。

4.  **第四阶段：完善与优化**
    *   开发团队主页、战绩统计等周边功能。
    *   进行全面的测试和体验优化。

这是一个高层次的规划。如果您决定开始开发，我们可以从第一阶段的数据库设计开始，逐步推进。
