# 已实现功能总结

该平台已实现了用户认证（登录、注册、个人资料管理，包括玩家升级为主办方）、比赛管理（创建、查看、更新、启动、房间信息获取）、比赛报名（玩家报名、退出报名、重新报名）、比赛对阵管理（获取对阵、设置获胜者）以及奖品管理（列表、详情、编辑、删除）的核心功能。

## 具体功能点

### 1. 用户管理

*   **用户登录 (`src/app/api/auth/login/route.ts`)**
    *   支持三种登录方式：主办方（用户名/密码）、玩家（游戏 ID）、玩家（手机号）。
    *   主办方登录必须使用用户名和密码。
    *   使用 `bcrypt` 进行密码哈希比对。
    *   成功登录后生成 JWT 并存储在 cookie 中，包含用户相关信息。
    *   提供详细的错误提示。

*   **用户注册 (`src/app/api/auth/register/route.ts`)**
    *   **角色注册：**
        *   **主办方：** 需提供用户名、密码、游戏 ID 和角色名称，密码哈希处理，并检查唯一性。
        *   **玩家：** 需提供游戏 ID。若已存在则更新角色名称、手机号、头像；若为新玩家则插入新记录并要求角色名称，检查唯一性。
    *   可选字段：手机号、直播间/主页地址、头像（默认 `000.webp`）。
    *   注册成功后生成 JWT。
    *   提供重复字段和缺少必填字段的错误提示。

*   **用户资料管理 (`src/app/api/users/me/route.ts`)**
    *   **GET：** 获取已认证用户的资料（不含敏感信息），需有效 JWT。
    *   **PUT：** 允许更新 `stream_url` 和 `avatar`。
        *   **玩家升级为主办方：** 玩家可提供用户名和密码升级，检查用户名唯一性，哈希密码，更新数据库并生成新 JWT。
    *   需有效 JWT。

### 2. 比赛管理

*   **比赛列表与创建 (`src/app/api/tournaments/route.ts`)**
    *   **GET：** 获取所有比赛列表，包含主办方信息和已报名玩家数量，按开始时间降序排列，解析奖品设置。
    *   **POST：** 允许主办方创建比赛。
        *   可设置比赛名称、时间、人数限制（10-48人）、说明、奖品、赛制、验证码。
        *   支持上传微信二维码和封面图（有默认图）。
        *   需主办方认证。

*   **特定比赛详情与更新 (`src/app/api/tournaments/[id]/route.ts`)**
    *   **GET：** 获取特定比赛详情，包含主办方信息、解析奖品设置、已结束比赛的最终排名。
    *   **PUT：** 允许主办方更新其创建的比赛信息（名称、时间、人数、说明、房间信息、验证码等），需主办方认证和所有权验证。
    *   **DELETE：** 禁止删除比赛。

*   **启动比赛 (`src/app/api/tournaments/[id]/start/route.ts`)**
    *   **POST：** 允许主办方启动特定比赛。
        *   需提供砺兵台房间信息并更新数据库。
        *   验证主办方所有权、比赛状态和报名人数。
        *   调用 `generateMatchesAndStartTournament` 函数（来自 `tournamentUtils`）来生成对阵并正式启动比赛。
        *   处理无效比赛 ID、未授权访问、无权限操作、比赛状态不正确和报名人数不足等错误。

*   **获取比赛房间信息 (`src/app/api/tournaments/[id]/room-info/route.ts`)**
    *   **GET：** 获取比赛房间信息。
    *   **权限控制：** 仅主办方或已报名的活跃玩家可查看。
    *   需有效 JWT。

*   **获取比赛对阵信息 (`src/app/api/tournaments/[id]/matches/route.ts`)**
    *   **GET：** 获取比赛所有对阵信息，包含玩家和获胜者信息、报名状态，按轮次和 ID 排序。

*   **设置比赛获胜者 (`src/app/api/matches/[id]/winner/route.ts`)**
    *   **POST：** 设置对阵获胜者。
        *   支持 `winner_id` 或 `forfeit_type`（双方弃权、单方弃权）。
        *   弃权会更新玩家报名状态。
        *   更新比赛记录并调用 `advanceTournamentRound` 推进比赛。

### 3. 比赛报名

*   **比赛报名 (玩家) (`src/app/api/tournaments/register/route.ts`)**
    *   **POST：** 玩家报名比赛。
        *   需 `tournament_id`、`character_name`、`character_id` 和有效 JWT。
        *   验证比赛状态、报名人数是否已满。
        *   插入报名记录，若达到最少人数则可能启动比赛。

*   **玩家报名 (通用) (`src/app/api/registrations/route.ts`)**
    *   **POST：** 玩家报名比赛。
        *   需 `tournamentId` 和可选 `registrationCode`。
        *   需有效 JWT。
        *   验证比赛是否存在、验证码、报名截止时间、比赛状态、人数是否已满。
        *   **禁止主办方报名自己组织的比赛。**
        *   处理重复报名（允许重新报名已退出的，禁止已弃权的）。

*   **退出报名 (`src/app/api/registrations/[id]/withdraw/route.ts`)**
    *   **POST：** 玩家退出报名。
        *   需 `registrationId` 和有效 JWT。
        *   验证报名记录和玩家所有权。
        *   **限制：** 报名截止后或比赛开始/结束后不允许退出。
        *   更新报名状态为 `withdrawn`。

### 4. 奖品管理

*   **奖品列表 (`src/app/api/prizes/route.ts`)**
    *   **GET：** 获取所有奖品列表。

*   **单个奖品管理 (`src/app/api/prizes/prizeById.ts`)**
    *   **GET：** 获取特定奖品详情。
    *   **PUT：** 更新奖品信息（名称、描述、图片 URL），需主办方认证。
    *   **DELETE：** 删除奖品，需主办方认证。

### 5. 前端界面

*   **首页 (`src/app/page.tsx`)**
    *   **比赛列表展示：**
        *   从 `/api/tournaments` 获取所有比赛数据。
        *   根据比赛状态（进行中、火热报名中、报名已截止、已结束、活动组织失败）进行分类和展示。
        *   每个比赛卡片显示名称、开始时间、报名人数、主办方信息（角色名称、头像）、封面图。
        *   “进行中”的比赛卡片额外显示房间名、房间号和直播间/主页链接，并有“观看比赛”按钮。
        *   “火热报名中”的比赛卡片额外显示报名截止时间、主要奖品信息和已报名玩家头像列表（限制显示数量）。
    *   **用户状态管理：**
        *   获取当前登录用户的 ID 和已报名的比赛 ID 列表，用于判断用户是否已报名某个比赛。
    *   **比赛报名功能：**
        *   “火热报名中”的比赛卡片上显示“登录后报名”或“一键报名”/“报名参赛”按钮。
        *   如果比赛需要参赛验证码，则弹出模态框要求输入验证码。
        *   调用 `/api/registrations` API 进行报名。
        *   报名成功后更新已报名比赛列表和已报名玩家头像。
    *   **响应式设计：** 页面布局适配不同屏幕尺寸。
    *   **视觉效果：** 采用中式国风武侠江湖风格，使用渐变背景、阴影、边框和悬停效果。

*   **登录页面 (`src/app/login/page.tsx`)**
    *   **登录表单：**
        *   提供“主办方登录”和“玩家登录”两种切换选项。
        *   **主办方登录：** 包含用户名和密码输入框。
        *   **玩家登录：** 包含游戏角色编号和手机号输入框（二选一）。
    *   **登录逻辑：**
        *   根据选择的登录类型，向 `/api/auth/login` 发送 POST 请求。
        *   成功登录后，重定向到首页。
        *   显示错误信息（如“账号不存在”、“密码不正确”等）。
    *   **注册链接：** 提供跳转到注册页面的链接。

*   **注册页面 (`src/app/register/page.tsx`)**
    *   **注册表单：**
        *   提供“玩家”和“主办方”两种角色选择。
        *   **主办方注册：** 需填写用户名、密码、燕云十六声角色编号、燕云十六声角色名称、手机号（可选）、直播间/主页地址（可选）。
        *   **玩家注册：** 需填写燕云十六声角色编号、燕云十六声角色名称、手机号（可选）。
        *   **输入验证：** 燕云十六声角色编号限制为 10 位数字，角色名称限制为中文汉字。
    *   **注册逻辑：**
        *   向 `/api/auth/register` 发送 POST 请求。
        *   成功注册后，重定向到首页。
        *   显示错误信息（如“角色名称已被占用”、“用户名已被占用”等）。
    *   **登录链接：** 提供跳转到登录页面的链接。
    *   **提示信息：** 页面顶部有关于角色 ID 和角色名称填写重要性的提示。

*   **个人资料页面 (`src/app/profile/page.tsx`)**
    *   **用户资料展示：**
        *   显示用户的角色名称、角色编号、用户名（如果为主办方）、角色身份。
    *   **头像管理：**
        *   显示当前头像，并提供可选头像列表供用户选择。
        *   调用 `/api/users/me/avatar` API 更新头像。
    *   **直播间/主页地址管理（主办方）：**
        *   如果用户是主办方，则显示并允许编辑直播间/主页地址。
        *   调用 `/api/users/me` API 更新直播间/主页地址。
    *   **玩家升级为主办方：**
        *   如果用户是玩家，则提供升级为主办方的选项。
        *   要求输入用户名和密码进行升级。
        *   调用 `/api/users/me` API 进行角色升级。
        *   升级成功后重定向到“我的比赛”页面。
    *   **认证与错误处理：**
        *   页面加载时验证用户 token，如果无效则重定向到登录页。
        *   显示操作成功或失败的消息。

*   **选择获胜者页面 (`src/app/matches/selectWinner.tsx`)**
    *   **功能：** 允许用户选择特定比赛对局的获胜者。
    *   **数据获取：**
        *   通过 URL 参数获取 `matchId`。
        *   **目前通过遍历所有比赛来查找特定对局，效率较低，未来需要优化为直接获取单个对局的 API。**
    *   **获胜者选择：**
        *   显示对局信息（回合、玩家 ID、状态）。
        *   提供单选按钮选择玩家 1 或玩家 2 作为获胜者。
        *   如果对局已结束，则禁用选择。
    *   **提交逻辑：**
        *   向 `/api/matches/winner` 发送 POST 请求，提交获胜者 ID。
        *   显示操作成功或失败的消息。
    *   **认证：** 需要有效的 token 进行操作。

*   **我的报名页面 (`src/app/my-registrations/page.tsx`)**
    *   **显示用户报名：** 获取并显示当前用户已报名的比赛列表。
    *   **报名详情：** 显示比赛名称、主办方、报名时间、比赛开始时间、报名截止时间、报名状态和比赛状态。
    *   **退出报名：**
        *   允许用户退出活跃的报名。
        *   需要确认。
        *   仅在报名截止日期前且比赛未开始/结束时允许。
        *   调用 `/api/registrations/[id]/withdraw` API。
    *   **重新报名：**
        *   允许用户重新报名已退出的比赛。
        *   需要确认。
        *   仅在报名截止日期前且比赛未开始/结束时允许。
        *   调用 `/api/registrations` API (POST)。
    *   **认证与错误处理：** 需要有效 JWT，处理未登录或无效 token 情况。

*   **我创建的比赛页面 (`src/app/my-tournaments/page.tsx`)**
    *   **显示主办方创建的比赛：** 获取并显示当前主办方用户创建的比赛列表。
    *   **比赛详情：** 显示比赛名称、开始时间、报名截止时间、状态和参赛人数范围。
    *   **查看详情：** 提供链接跳转到特定比赛的详情页面。
    *   **认证与错误处理：** 需要有效 JWT，如果未登录或无权限则重定向到登录页。

*   **管理奖品页面 (`src/app/prizes/manage.tsx`)**
    *   **奖品列表：**
        *   从 `/api/prizes` 获取并显示所有现有奖品。
        *   每个奖品显示名称、描述和图片。
        *   提供“编辑”和“删除”操作。
    *   **创建新奖品：**
        *   表单允许输入新奖品的名称、描述和图片 URL。
        *   通过 POST 请求提交到 `/api/prizes`。
        *   需要认证（JWT token），并假定用户是“主办方”。
        *   成功创建后刷新奖品列表。
    *   **删除奖品：**
        *   “删除”按钮触发确认对话框。
        *   通过 DELETE 请求发送到 `/api/prizes/prizeById?id={prize.id}`。
        *   需要认证（JWT token），并假定用户是“主办方”。
        *   成功删除后刷新奖品列表。
    *   **错误处理：** 显示操作成功、获取失败或未授权的消息。

*   **编辑奖品页面 (`src/app/prizes/edit.tsx`)**
    *   **功能：** 允许编辑现有奖品的详细信息。
    *   **数据获取：**
        *   通过 URL 参数获取 `prizeId`。
        *   从 `/api/prizes/prizeById?id={prizeId}` 获取奖品详情，并填充到表单中。
    *   **编辑表单：**
        *   包含奖品名称、描述和图片 URL 的输入框。
    *   **提交逻辑：**
        *   向 `/api/prizes/prizeById?id={prizeId}` 发送 PUT 请求，提交更新后的奖品信息。
        *   成功更新后，重定向到奖品管理页面 (`/prizes/manage`)。
        *   显示操作成功或失败的消息。
    *   **认证与错误处理：**
        *   需要有效的 JWT token 进行认证，并假定用户是“主办方”。
        *   处理奖品 ID 缺失、未授权、获取失败和更新失败等错误。

*   **比赛注册页面 (`src/app/tournamentRegister/page.tsx`)**
    *   **功能：** 允许玩家浏览并报名参加开放报名的比赛。
    *   **比赛列表：**
        *   从 `/api/tournaments` 获取所有比赛列表。
        *   根据比赛状态（“报名中”或“延期报名中”）过滤并显示可报名的比赛。
        *   显示比赛名称、开始时间、报名截止时间、当前状态和已报名人数/最大人数。
    *   **报名功能：**
        *   如果比赛需要验证码，则显示验证码输入框和“报名参赛”按钮。
        *   如果不需要验证码，则显示“一键报名”按钮。
        *   点击报名按钮后，向 `/api/registrations` 发送 POST 请求。
        *   成功报名后，刷新比赛列表并显示成功消息。
    *   **认证与错误处理：**
        *   需要登录才能报名，如果未登录则提示登录。
        *   显示操作成功或失败的消息。

*   **创建比赛页面 (`src/app/tournaments/create/page.tsx`)**
    *   **功能：** 允许主办方创建新的比赛。
    *   **表单字段：**
        *   比赛名称 (`name`)
        *   比赛开始时间 (`startTime`)
        *   报名截止时间 (`registrationDeadline`) (可选，默认为开始时间)
        *   最少参赛人数 (`minPlayers`) (默认 10)
        *   最多参赛人数 (`maxPlayers`) (默认 48)
        *   赛事说明 (`eventDescription`)
        *   微信群二维码文件上传 (`wechatQrCodeFile`) (可选)
        *   比赛封面图文件上传 (`coverImageFile`) (可选，有默认图)
        *   参赛验证码 (`registrationCode`) (可选)
        *   默认比赛赛制 (`defaultMatchFormat`) (下拉选择：1局1胜, 3局2胜, 5局3胜)
    *   **奖品设置：**
        *   **固定排名奖品：** 默认提供第 1 到第 5 名的奖品设置，可选择奖品 ID 和数量。
        *   **参与奖：** 可选择奖品 ID 和数量。
        *   **自定义奖项：** 允许添加多个自定义奖项，每个奖项可设置自定义名称、起始名次、结束名次、奖品 ID 和数量，并支持移除。
        *   奖品选择下拉框的数据来源于 `/api/prizes`。
    *   **表单验证：**
        *   比赛开始时间不能是过去的时间。
        *   报名截止时间不能晚于比赛开始时间。
    *   **提交逻辑：**
        *   将表单数据（包括文件和 JSON 格式的奖品设置）通过 `FormData` 发送到 `/api/tournaments`。
        *   成功创建后，重定向到新创建比赛的详情页面 (`/tournaments/details?id={newTournament.id}`)。
        *   显示错误提示。
    *   **认证：** 需要有效的 JWT token。

## 待优化或待实现的功能

*   **比赛对局详情获取效率：** `src/app/matches/selectWinner.tsx` 中获取单个对局详情的方式效率较低，建议优化为直接获取单个对局的 API。
*   **玩家数据统计和排行榜：** PRD 中提及的玩家数据统计（参赛数量、获奖次数）和玩家排行榜功能尚未在代码中体现。
*   **平台管理员功能：** PRD 中提及的平台管理员后台管理仪表盘和相关权限（如封禁用户、删除违规比赛）尚未实现。
*   **奖品管理权限：** `prizeById.ts` 中奖品管理权限注释为 `organizer`，但 PRD 建议是 `admin`，这可能是一个待确认或待调整的点。
*   **图片存储优化：** PRD 中提及的图片文件暂时存储在代码库中，后期迭代再考虑优化至云存储服务，目前仍是本地存储。
*   **比赛状态流转的自动化：** 虽然有 `generateMatchesAndStartTournament`，但 PRD 中关于报名截止时自动检查人数并改变状态的逻辑，以及比赛结束后自动生成最终排名的逻辑，需要进一步确认其自动化程度和完整性。
