# 项目：1v1竞技比赛管理平台

**功能定位：** 本文档作为产品需求文档 (PRD)，旨在明确1v1竞技比赛管理平台的功能需求、用户体验要求和系统行为规范，为 Gemini-CLI 提供清晰的开发指南和框架。

**版本:** 1.0.0
**最后更新:** 2025年7月24日

## 1. 项目概述

本项目旨在创建一个管理玩家1v1竞技比赛的平台。平台服务于两类主要用户：比赛主办方和参赛玩家。真实比赛将在主办方创建的**燕云十六声砺兵台房间**中进行。当前版本主要支持**1v1个人赛**，暂不支持5v5团队赛（后期版本可考虑增加，项目设计需注意兼容性）。系统将自动化处理部分流程，如比赛匹配和报名限制，同时赋予主办方管理比赛进程的关键权限。

## 2. 视觉风格

网站整体风格需紧扣 **“国风武侠”** 主题，通过视觉元素与内容的呼应，旨在为玩家营造身临其境的江湖代入感，同时清晰传递游戏的核心玩法与特色。宣传语 “旧的英雄，已随烽烟与传说远去；新的侠客面对浩瀚江湖，又将去向何处？天地为炉，以身化剑，斩破乱世，仗剑而行。” 配色和样式应服务于 “天地为炉，以身化剑” 的游戏世界观，传递出古朴、厚重又充满江湖豪情的视觉体验。

**重要提示：** 为保证平台整体视觉风格的统一性，所有页面必须严格遵循国风配色方案，包括但不限于：深숯灰（#1A1A1A）、暗金（#B89766）、朱砂红（#C83C23）和象牙白（#F5F5F5）。

### 2.1. 响应式设计

所有页面都必须适配 PC 端和移动端，确保在不同屏幕尺寸和设备上都能提供良好的用户体验和视觉效果。

## 3. 用户角色

*   **比赛主办方 (Organizer):**
    *   可以创建、配置和管理一场完整的比赛。
    *   负责在每轮比赛后指定获胜者。
    *   **注册与登录:** 需提供账号密码，同时绑定个人**燕云十六声角色编号**和**燕云十六声角色名称**（要求与玩家一致，数据自动保存到玩家表中）。注册后自动登录，网页除了显示其游戏角色名称外，还拥有创建和管理比赛的相关权限。
    *   **比赛管理权限:** 对已创建的比赛无删除权限，只允许修改资料。
    *   **直播间/主页地址:** 注册时可提供直播间地址（如 `https://live.douyin.com/813154277194`）或平台主页地址（如 `https://www.douyin.com/user/MS4wLjABAAAA...`），方便引导宣传。
    *   **主办方作为玩家:** 主办方在游戏中也是玩家，拥有玩家的全部权限。主办方登录后可以直接用自己的玩家身份报名符合条件的比赛，但**禁止报名自己组织的比赛**。主办方登录后，其账号将同时拥有玩家的全部权限，无需再通过玩家角色编号登录。
*   **玩家 (Player):**
    *   无需注册账号密码，只用输入自己的游戏ID即可参与。
    *   可以浏览和报名参加由主办方创建的比赛。
    *   **注册与登录:** 玩家输入**燕云十六声角色编号**进行注册。当系统内没有保存此编号时，提示用户补充其**燕云十六声角色名称**。数据会自动保存到系统。用户可选补充**手机号**管理游戏ID，游戏ID或手机号可作为用户账号。注册后自动登录，网页显示玩家角色名称。
    *   **参赛资格:** 报名成功后，必须用报名的角色参加比赛，奖品也只发放到对应ID的角色。
    *   **报名比赛:** 登录的玩家可以一键报名可报名的比赛，玩家可以同时报名多个比赛，且暂不做任何限制。
    *   **查看已报名比赛:** 玩家可以查看自己已报名的比赛列表。
    *   **退出报名:** 在比赛开始前可以退出报名，如果系统已完成对战分组，则此玩家视为弃权。
    *   **修改个人资料:** 登录后，玩家可以在个人资料页面修改自己的头像。
    *   **玩家升级为主办方:** 在系统中登记过的玩家，可以补充账号密码信息，注册成为比赛主办方。
*   **平台管理员 (Admin):**
    *   Admin 是系统最高管理员，无前端用户权限，使用专用后端管理系统管理平台，负责运维系统。
    *   **管理权限:** 包括所有数据查看权限（包括系统日志）、禁封用户登录权限、下线主办方组织的比赛权限（比如删除无效比赛或强制让被投诉比赛进入组织失败状态），以及其它系统管理员应该拥有的权限。
    *   **奖品管理:** 负责在后台配置和管理平台默认的奖品池。
    *   **管理界面:** 后续可考虑开发独立的后台管理仪表盘。

## 4. 核心功能

### 4.1. 主办方功能

*   **创建比赛:**
    *   设置比赛的开始时间。
    *   设置最少参赛人数（硬性要求：不得少于10人）。
    *   设置最大参赛人数（**单次最大人数上限规定为48人**，因为砺兵台房间人数上限是50人）。
    *   **赛事说明:** 提供赛事说明文本框，让玩家了解参赛条件、比赛流程、注意事项等。**（已提供默认内容，方便主办方填写）**
    *   **比赛封面:** 可选上传比赛封面配图。如果未上传，则使用 `public/images/default_cover.jpg` 作为默认封面。
    *   **微信群二维码:** 提供一个微信群二维码**图片上传**功能，此项为非必填项。如果未填写，需要玩家在游戏中主动加主办方为好友参加比赛。**上传图片时，系统会自动生成唯一且不包含中文的文件名，以避免兼容性问题。**
    *   **奖品设置:**
        *   默认提供第一名到第五名的奖品和数量设置。
        *   设置参与奖的奖品和数量（所有未获得名次奖品的参赛玩家）。
        *   奖品可以为“无”，例如只给第一名发奖，其他人无奖品。
        *   提供自定义奖项的奖品和数量设置，自定义奖不限制数量，可由主办方自己设置以取代固定奖项（例如：三到五名的奖品，五到十名的奖品，10到20名的奖品等）。
    *   **报名截止时间:** 必填项，如果不填默认为比赛开始时间。**如果填写，则不得大于比赛开始时间。**
    *   **砺兵台房间信息:** 在比赛开始前，主办方需补充填写自己创建的砺兵台房间名（限制9个字符）、房间号（10位数字）和房间密码（4位数字，如果没有密码为开放式房间）。**提示：创建房间的玩法类型必须是1V1，挑战模式必须是管理模式。**
    *   **参赛验证码:** 可选设置一个参赛验证码，方便创建非公开比赛（如内部赛），玩家需填写验证码才能报名参赛。
*   **管理比赛:**
    *   比赛开始后，可以查看对阵图。
    *   为每一组对局手动选择获胜者，以推进比赛进入下一轮。
    *   对已创建的比赛无删除权限，只允许修改资料。
    *   **活动组织失败处理:** 如果报名截止时已报名比赛玩家未达最少参赛人数设置，视为活动组织失败，由主办方决定关闭比赛（状态为“已关闭”）或延长报名时间调整比赛日期（状态可以为“报名中”或“延期报名中”）。
    *   **获胜者标记:** 主办方要能方便快捷地标记分组中的获胜者。**支持标记单方弃权（另一方获胜）或双方弃权（无胜者）。**

### 4.2. 玩家功能

*   **报名参赛:**
    *   在比赛报名截止前，可以报名参加。
    *   报名时必须提供以下信息：
        *   **燕云十六声角色编号 (10位数字UID):** 唯一的数字ID，**不得重复**。
        *   **燕云十六声角色名称:** **不得重复**。
        *   **手机号:** 可选补充，用于管理游戏ID。
    *   **报名入口规范:** 为确保流程清晰和安全，所有比赛的报名和退出功能入口**仅限于比赛详情页**。其他页面（包括首页）将不再提供直接的报名或退出按钮，仅提供引导至详情页的链接或信息展示。
*   **查看比赛记录和获奖记录:** 玩家角色可以查看自己参与过的比赛记录和获奖记录。（**待开发**）
*   **退出报名:** 对已报名的比赛只能在比赛开始前退出报名，比赛开始后无法退出。**退出报名后在报名截止时间前还可以重新报名。**
*   **玩家数据统计:**
    *   新增小节，描述需要统计的玩家数据：参赛数量、获得第1、2、3名的次数。
    *   提及未来实现玩家排行榜的功能，激励玩家参与。

### 4.3. 系统自动化逻辑

*   **比赛规则自动配置:**
    *   系统会根据最终参赛人数，自动配置最合适的比赛赛制（例如，1局1胜、3局2胜）。
    *   **特殊规则:** 冠军赛（决赛）必须为5局3胜制。
    *   **赛制建议:** 平台可根据报名分组给出建议的赛制（例如48进24推荐一局一胜，12进6推荐三局二胜，决赛推荐五局三胜）。这些赛制建议仅用于在对阵图上展示，实际比赛的几局几胜制由主办方在游戏中控制。
    *   **砺兵台挑战模式:** 房间挑战模式必须设置为管理模式，由主办方根据网站生成的1v1分组选择成员上场。
*   **报名与匹配:**
    *   当报名人数达到“最大参赛人数”后，系统自动关闭报名通道。
    *   当报名截止时间到达时，系统检查报名人数。
        *   如果报名人数达到主办方设置的“最少参赛人数”，则比赛进入“即将开始”或“比赛准备中”状态。对阵图将在主办方点击“开始比赛”后生成。
        *   如果报名人数未达到“最少参赛人数”，则视为活动组织失败，比赛状态变为“已失败 (failed)”，由主办方决定关闭比赛或延长报名时间。
*   **晋级流程:**
    *   主办方选定胜者后，系统自动将胜者匹配到下一轮比赛，直到决出最终冠军。当出现冠军后，比赛状态自动改为“已结束”。
    *   **玩家未参赛场景处理:**
        *   **一人未到场:** 默认到场玩家获胜。
        *   **两人均未到场:** 比赛结果为“无胜者”或“平局”，不产生晋级者。主办方可选择标记为“双方弃权”。
        *   **弃赛标记:** 主办方可以标记玩家为“弃赛”状态。
        *   **恶意弃赛风险管理:** 标记弃赛玩家后期可显示在玩家资料中，甚至限制弃赛超过多少次的玩家报名比赛。
*   **最终排名生成规则:**
    *   比赛结束后，系统会根据所有对局记录自动生成最终排名。
    *   **排名规则：**
        1.  **主要排名依据（淘汰轮次）：** 在所有未弃权的玩家中，根据被淘汰的轮次进行排名。被淘汰的轮次越高，排名越高。
        2.  **次要排名依据（对手强度/决胜分）：** 如果多名玩家在同一轮被淘汰且均未弃权，系统将比较淘汰他们的**对手的最终排名**。输给最终排名更高的对手的玩家，其排名会更高。
        3.  **弃赛排名要求：** 任何形式的弃权（包括单方弃权和双方弃权，这两种情况均属于报名后弃权）的玩家，其排名都将低于所有正常完成比赛的玩家。在弃权玩家中，根据弃权发生的轮次进行排名，弃权轮次越早，排名越低。
        4.  **并列排名要求：** 只有当所有排名依据（是否弃权、淘汰轮次、对手的最终排名）都完全相同时，玩家才会获得并列排名。
*   **比赛状态流转:**
    *   **待定 (pending):** 比赛创建后的初始状态。
    *   **火热报名中:** 比赛创建后，在报名截止时间之前的状态。
    *   **活动组织失败 (failed):** 报名时间截止后，若报名人数未达到最少要求，则进入此状态。
    *   **即将开始:** 报名截止后、比赛开始前，且报名人数达标的状态。
    *   **比赛准备中:** 比赛时间已到，但主办方尚未点击“开始比赛”的状态。
    *   **进行中 (ongoing):** 主办方点击“开始比赛”后，比赛正式开始。
    *   **已结束 (finished):** 决出最终冠军后。
    *   **延期报名中 (extended_registration):** 主办方在活动组织失败后，选择延长报名时间。

### 4.4. 网站首页展示

*   **赛事列表:** 网站首页为赛事列表，显示以下类型的比赛：
    *   **正在进行中的比赛:** 报名已结束，正在比赛中。除了显示比赛信息，还要显示直播间地址和燕云十六声砺兵台房间号。玩家可在游戏中搜索房间号进入观战（前提是房间人数未超过50人且房间未设置密码或主办方填写了密码）。
    *   **即将开始的比赛:** 包括“火热报名中”、“即将开始”和“比赛准备中”的比赛。**火热报名中的比赛，即使未登录用户也能看到已报名玩家的头像列表（限制显示数量，例如10个），以刺激玩家登录报名。**
    *   **已经结束的比赛。**
    *   **活动组织失败的比赛:** 将以卡片式列表展示，包含配图、名称、比赛信息和状态。

### 4.5. 比赛详情页

*   **公开访问:** 比赛详情页对所有用户（包括未登录用户）开放访问，但部分信息（如砺兵台房间信息）和操作（如开始比赛、标记胜者）将根据用户登录状态和角色进行权限控制。
*   **玩家分组状态:** 显示比赛匹配的玩家分组状态。
*   **获胜者设置:** 正在进行中的比赛要由主办方设置每组获胜者玩家。
*   **玩家信息显示:** 玩家信息只公开显示角色名称，角色编号只公开显示前3位和最后3位。
*   **对阵图显示优化:**
    *   显示对阵轮数（例如：“第 1 轮”）。
    *   显示比赛阶段（例如：“淘汰赛”、“1/8 决赛”、“1/4 决赛”、“半决赛”、“决赛”）。
    *   显示每一局对战的结束时间。
    *   在比赛结束后，显示最终排名（目前为冠军和其余玩家的简易排名）。
    *   双方弃权的比赛结果显示为“双方弃权”。
    *   **未生成对阵图时，详细列表所有已报名玩家的图像（不包括已退出报名的玩家）。**
    *   **已生成对阵图时，美化对阵图样式，除了玩家的名称，还显示玩家的图像。**
    *   **比赛结束后，显示玩家名次的同时根据名次显示玩家获得的奖品。**

*   **奖品介绍:** 比赛详情页增加奖品介绍，包括奖品名称和数量。
*   **主播信息:** 比赛详情页增加主播（比赛主办方）的主页地址（对应用户表中的 `stream_url`）和直播间地址（保存在比赛表中，在主办方点开始比赛时填写砺兵台房间信息时填写）。直播间地址为可选，如果填写直播地址，在详情页显示“正在直播中”的按钮方便用户进入直播间观看比赛。
*   **砺兵台房间信息:** 砺兵台房间信息（房间名、房间号、房间密码）仅限主办方和已报名玩家可见.

### 4.6. 奖品管理

*   **奖品列表:** 包括系统默认设置的奖品，也可以由主办方自己定义奖品。**系统提供统一的奖品池供主办方选择。**
*   **自定义奖品:** 主办方自定义的奖品仅主办方自己可选，系统设置奖品为所有比赛公用。

### 4.7. 个人主页

*   **玩家和主播（比赛主办方）都将拥有公开的个人主页，用于显示个人信息和比赛相关数据，包括比赛记录和获奖记录。**
*   **玩家公开主页标识:** 玩家的公开主页将通过一个唯一的 `uuid` 字段来标识，而不是 `game_id`，以保护玩家的 `game_id` 不在公开 URL 中暴露。

### 4.8. 系统增强功能

*   **用户行为日志:**
    *   系统应记录用户的登录行为数据，包括登录 IP、登录次数和登录时间，以提供用户行为日志，保障系统安全。
*   **比赛页面访问统计:**
    *   增加各比赛详情页面的访问数据统计功能，方便主办方根据页面访问量了解比赛的关注度。



## 5. 开发流程/规范

### 5.1. 通用开发规范

1.  本项目是中文项目，所有文档和更新日志使用中文。

*   **版本控制:** 项目使用Git进行管理。
*   **开发流程:** 在每次开发完成并告知您进行测试后，我将等待您的测试结果确认无误。在您明确指示继续开发或给出其他指令之前，我不会自动进行下一步开发任务。

### 5.2. Gemini-CLI 开发行为准则

为确保开发过程的质量、效率和主动性，我将严格遵守以下行为准则：

1.  **优先复用现有代码和模式:**
    在实现任何功能或进行修改之前，我将主动搜索并优先利用项目中已存在的工具函数、辅助模块、设计模式和库。避免重复造轮子，确保代码一致性。
2.  **主动提出优化建议:**
    我将不仅仅局限于完成用户提出的具体任务，而是会主动分析代码，识别潜在的性能瓶颈、安全漏洞、可维护性问题或不符合项目规范的地方，并向用户提出改进建议。
3.  **关注代码质量和安全性:**
    在每次代码修改或新增功能时，我将主动考虑其对整体代码质量、系统安全性和长期可维护性的影响，并采取措施确保这些方面得到保障。
4.  **预判和前瞻性思考:**
    我将努力预判用户可能的需求和项目未来的发展方向，提前规划和设计，以提供更具前瞻性的解决方案。
5.  **技术栈与模块系统一致性：** 在引入新的库、模块或开发独立脚本时，我将严格遵循项目已确立的技术栈和模块系统（如 ESM 或 CommonJS）规范。对于需要与项目内部代码交互的独立脚本，我将确保其运行环境与主应用模块加载机制兼容，避免引入不必要的复杂性或技术债。

### 5.3. 数据库操作规范

*   **优先使用 `query` 辅助函数:** 为了简化异步操作并统一错误处理，所有数据库查询都应优先使用 `src/database.mjs` 中提供的 `query` 辅助函数。
*   **`query` 函数用法:**
    ```javascript
    import { query } from '@/database.mjs';
    const results = await query('SELECT * FROM Users WHERE id = ?', [userId]);
    ```
*   **直接访问 `db` 对象:** 仅在需要执行事务或 `query` 函数无法满足的复杂场景下，才应直接使用 `db` 对象。
*   **数据库列添加规范:** 对于已上线的项目，在 `src/database.js` 中添加新的数据库列时，必须使用 `ALTER TABLE ... ADD COLUMN` 语句，而不是直接修改 `CREATE TABLE` 语句的内部定义，以避免删除现有数据库。

### 5.4. Gemini-CLI 内部操作规范

以下是指导 Gemini-CLI 自身行为和操作的内部规范：

1.  **主动阅读和更新技术文档:** 作为开发代理，我必须在必要时主动阅读和更新 `docs` 目录下的技术文档，以确保对项目有最全面的理解和最新的信息。
2.  **Git 提交规范:**
    *   在执行 `git commit` 操作时，我必须使用 `git commit -F commit_message.txt` 的方式提交。
    *   在执行 `git commit` 操作后，我必须使用 `del commit_message.txt` 删除临时文件。
3.  **GEMINI.md 更新与维护:** 当项目出现新的产品需求或核心功能定义时，我将主动请求更新 `GEMINI.md`。在更新过程中，若发现与现有规则存在冲突，我将寻求用户确认，以确保关键信息不被误删或遗漏。
4.  **数据库文件路径规范:** 鉴于 Next.js 构建环境的特殊性，为确保数据库文件 `database.db` 始终能被正确访问，应使用 `path.join(process.cwd(), 'database.db')` 来构建数据库文件的绝对路径。这能保证无论在开发环境还是生产构建后，应用程序都能正确找到位于项目根目录的数据库文件。
